name: Build Tuta Official Patched

on:
  workflow_dispatch:

jobs:
  build_flatpak:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Build Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder jq
          flatpak remote-add --user --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

      - name: Clone Official Repo
        run: git clone --depth 1 https://github.com/flathub/com.tutanota.Tutanota.git official-repo

      - name: Prepare Local Source
        run: |
          APPIMAGE_URL=$(curl -s https://api.github.com/repos/tutao/tutanota/releases | jq -r 'map(select(.tag_name | contains("tutanota-desktop-release"))) | first | .assets[] | select(.name | endswith(".AppImage")) | .browser_download_url')
          wget -q $APPIMAGE_URL -O tutanota.AppImage
          chmod +x tutanota.AppImage
          ./tutanota.AppImage --appimage-extract > /dev/null
          mv squashfs-root tutanota-desktop
          tar -czf tutanota-unpacked-linux.tar.gz tutanota-desktop/
          echo "NEW_SHA=$(sha256sum tutanota-unpacked-linux.tar.gz | cut -d' ' -f1)" >> $GITHUB_ENV

      - name: Patch Manifest
        run: |
          jq --arg sha "$NEW_SHA" --arg path "file://$(pwd)/tutanota-unpacked-linux.tar.gz" \
          '(.modules[] | select(.name=="tutanota") | .sources[] | select(.type=="file" and ."dest-filename"=="tutanota-unpacked-linux.tar.gz")) |= (.url = $path | .sha256 = $sha)' \
          official-repo/com.tutanota.Tutanota.json > patched.json
          mv patched.json official-repo/com.tutanota.Tutanota.json

      - name: Build Flatpak
        run: |
          flatpak-builder --user --install-deps-from=flathub --disable-rofiles-fuse --force-clean --repo=repo build_dir official-repo/com.tutanota.Tutanota.json
          flatpak build-bundle repo Tuta-Custom.flatpak com.tutanota.Tutanota

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Tuta-Flatpak-Bundle
          path: Tuta-Custom.flatpak
